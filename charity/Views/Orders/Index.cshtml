@model IEnumerable<OrderViewModel>

@section Styles {
    <link href="~/lib/datatables/css/jquery.datatables.min.css" rel="stylesheet">
}

<button class="btn btn-info" id="addNew"><i class="fa-solid fa-plus"></i> 新增訂單</button>
<table class="table table-striped table-hover" style="width:100%">
    <thead class="table-primary">
        <tr>
            <th>@Html.DisplayNameFor(model => model.Id)</th>
            <th>@Html.DisplayNameFor(model => model.Buyer)</th>
            <th>@Html.DisplayNameFor(model => model.OrderTime)</th>
            <th>@Html.DisplayNameFor(model => model.TotalPrice)</th>
            <th>@Html.DisplayNameFor(model => model.StatusName)</th>
            <th></th>
        </tr>
    </thead>
</table>

@section Scripts {
    <script src="~/lib/datatables/js/jquery.datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function () {
            // Initialize DataTable
            let orderItems = []; // 本地保存的商品列表
            $('table').DataTable({
                ajax: {
                    type: 'GET',
                    url: '/Orders/IndexJson',
                    datatype: 'json',
                    dataSrc: 'data' // Ensure proper JSON extraction
                },
                columns: [
                    { "data": "id", "width": "15%" },
                    { "data": "buyer", "width": "20%" },
                    {
                        "data": "orderTime", "width": "20%",
                        "render": function (data) {
                            if (data) {
                                var date = new Date(data);
                                return date.toLocaleString('zh-TW', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    hour12: false
                                });
                            }
                            return "N/A";
                        }
                    },
                    { "data": "totalPrice", "width": "15%" },
                    { "data": "statusName", "width": "15%" },
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            return `<button class="btn btn-warning editBtn" data-id="${row.orderId}"><i class="fa-solid fa-pen"></i> 編輯</button>`;
                        },
                        "className": "text-center",
                        "width": "15%"
                    }
                ],
                fixedHeader: { header: true },
                language: { url: 'https://cdn.datatables.net/plug-ins/1.13.1/i18n/zh-HANT.json' }
            });

            $('table').on('click', 'tr', function () {
                var data = $('table').DataTable().row(this).data();
                var orderId = data.id;

                $.ajax({
                    url: '/Orders/Details/' + orderId,
                    type: 'GET',
                    success: function (result) {
                        Swal.fire({
                            title: '訂單詳情',
                            html: result,
                            showCancelButton: false,
                            showDenyButton: true,
                            denyButtonText: '刪除',
                            confirmButtonText: '確認',
                            width: '800px'
                        }).then((result) => {
                            // 如果用戶點擊 "刪除"
                            if (result.isDenied) {
                                Swal.fire({
                                    title: '確定要刪除此訂單嗎？',
                                    text: '此操作無法復原！',
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonText: '是的，刪除！',
                                    cancelButtonText: '取消'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        // 發送刪除請求到服務器
                                        $.ajax({
                                            url: '/Orders/Delete/' + orderId,
                                            type: 'POST',
                                            success: function (response) {
                                                if (response.success) {
                                                    Swal.fire('已刪除！', '該訂單已成功刪除。', 'success');
                                                    // 刷新 DataTables，更新刪除後的內容
                                                    $('table').DataTable().ajax.reload();
                                                } else {
                                                    Swal.fire('錯誤！', response.message || '無法刪除該訂單。', 'error');
                                                }
                                            },
                                            error: function () {
                                                Swal.fire('錯誤！', '無法刪除該訂單。', 'error');
                                            }
                                        });
                                    }
                                });
                            }
                        });
                    },
                    error: function () {
                        Swal.fire('錯誤', '無法獲取訂單詳情', 'error');
                    }
                });
            });
        });
        $('#addNew').click(function () {
            $.ajax({
                url: '/Orders/Create',
                type: 'GET',
                success: function (result) {
                    Swal.fire({
                        title: '新增訂單',
                        html: result, // 插入 partial view 的內容
                        showCancelButton: true,
                        confirmButtonText: '新增',
                        didOpen: function () {
                            // 綁定表單提交事件
                            $('#createOrderForm').on('submit', function (e) {
                                e.preventDefault();
                                var formData = $(this).serialize();
                                $.ajax({
                                    url: '/Orders/Create',
                                    type: 'POST',
                                    data: formData,
                                    success: function (response) {
                                        if (response.success) {
                                            Swal.fire('成功', '訂單已成功新增！', 'success');
                                            // 更新表格
                                            $('table').DataTable().ajax.reload();
                                        } else {
                                            Swal.fire('錯誤', response.errors.join('<br>'), 'error');
                                        }
                                    }
                                });
                            });
                        },
                        preConfirm: () => {
                            $('#createOrderForm').submit();
                        }
                    });
                }
            });
        });
        let orderItems = []; // 本地保存的商品列表

        // 事件委派確保適用於動態載入的 Partial View
        $(document).on('click', '#addItem', function () {
            const productId = $('#ProductIdInput').val();
            const quantity = $('#QuantityInput').val();

            if (!productId || !quantity || quantity <= 0) {
                alert('請輸入有效的商品 ID 和數量');
                return;
            }

            // 新增商品到本地 orderItems
            orderItems.push({ ProductId: productId, Quantity: quantity });

            // 更新前端顯示
            const newItemHtml = `
                            <div class="order-item mb-3">
                                <p>商品 ID: ${productId}</p>
                                <p>數量: ${quantity}</p>
                            </div>`;
            $('#orderItems').append(newItemHtml);

            // 清空輸入欄位
            $('#ProductIdInput').val('');
            $('#QuantityInput').val('');
        });
    </script>
}