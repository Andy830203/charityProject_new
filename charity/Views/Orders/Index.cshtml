@model IEnumerable<OrderViewModel>

@section Styles {
    <link href="~/lib/datatables/css/jquery.datatables.min.css" rel="stylesheet">
}

<button class="btn btn-info" id="addNew"><i class="fa-solid fa-plus"></i> 新增訂單</button>
<table class="table table-striped table-hover" style="width:100%">
    <thead class="table-primary">
        <tr>
            <th>@Html.DisplayNameFor(model => model.Id)</th>
            <th>@Html.DisplayNameFor(model => model.Buyer)</th>
            <th>@Html.DisplayNameFor(model => model.OrderTime)</th>
            <th>@Html.DisplayNameFor(model => model.TotalPrice)</th>
            <th>@Html.DisplayNameFor(model => model.StatusName)</th>
            <th></th>
        </tr>
    </thead>
</table>

@section Scripts {
    <script src="~/lib/datatables/js/jquery.datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function () {
            // Initialize DataTable
            $('table').DataTable({
                ajax: {
                    type: 'GET',
                    url: '/Orders/IndexJson',
                    datatype: 'json',
                    dataSrc: 'data' // Ensure proper JSON extraction
                },
                columns: [
                    { "data": "id", "width": "15%" },
                    { "data": "buyer", "width": "20%" },
                    {
                        "data": "orderTime", "width": "20%",
                        "render": function (data) {
                            if (data) {
                                var date = new Date(data);
                                return date.toLocaleString('zh-TW', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    hour12: false
                                });
                            }
                            return "N/A";
                        }
                    },
                    { "data": "totalPrice", "width": "15%" },
                    { "data": "statusName", "width": "15%" },
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            return `<button class="btn btn-warning editBtn" data-id="${row.orderId}"><i class="fa-solid fa-pen"></i> 編輯</button>`;
                        },
                        "className": "text-center",
                        "width": "15%"
                    }
                ],
                fixedHeader: { header: true },
                language: { url: 'https://cdn.datatables.net/plug-ins/1.13.1/i18n/zh-HANT.json' }
            });

            $('table').on('click', 'tr', function () {
                var data = $('table').DataTable().row(this).data();
                var orderId = data.id;

                $.ajax({
                    url: '/Orders/Details/' + orderId,
                    type: 'GET',
                    success: function (result) {
                        Swal.fire({
                            title: '訂單詳情',
                            html: result,
                            showCancelButton: false,
                            showDenyButton: true,
                            denyButtonText: '刪除',
                            confirmButtonText: '確認',
                            width: '800px'
                        }).then((result) => {
                            // 如果用戶點擊 "刪除"
                            if (result.isDenied) {
                                Swal.fire({
                                    title: '確定要刪除此訂單嗎？',
                                    text: '此操作無法復原！',
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonText: '是的，刪除！',
                                    cancelButtonText: '取消'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        // 發送刪除請求到服務器
                                        $.ajax({
                                            url: '/Orders/Delete/' + orderId,
                                            type: 'POST',
                                            success: function (response) {
                                                if (response.success) {
                                                    Swal.fire('已刪除！', '該訂單已成功刪除。', 'success');
                                                    // 刷新 DataTables，更新刪除後的內容
                                                    $('table').DataTable().ajax.reload();
                                                } else {
                                                    Swal.fire('錯誤！', response.message || '無法刪除該訂單。', 'error');
                                                }
                                            },
                                            error: function () {
                                                Swal.fire('錯誤！', '無法刪除該訂單。', 'error');
                                            }
                                        });
                                    }
                                });
                            }
                        });
                    },
                    error: function () {
                        Swal.fire('錯誤', '無法獲取訂單詳情', 'error');
                    }
                });
            });
        });
    </script>
}